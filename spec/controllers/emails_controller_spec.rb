require 'spec_helper'

describe EmailsController do
  describe "POST #create" do
    it "saves to the right place from mailgun" do
      @project = FactoryGirl.create(:project, :email => "acdivoca@agilechamp.mailgun.org")
      @parent_email = FactoryGirl.create(:email)
      post :create, { 
        "recipient"=>"acdivoca-#{@parent_email.id}@agilechamp.mailgun.org", 
        "sender"=>"jimknight@lavatech.com",
        "subject"=>"test",
        "from"=>"Jim Knight <jimknight@lavatech.com>",
        "body-html" => "Jim was <b>here</b>." }
      Email.where(:subject => "test").last.parent.id.should == @parent_email.id
      @project.emails.count.should == 1
    end
    it "should record the cc value" do
      @project = FactoryGirl.create(:project, :email => "acdivoca@agilechamp.mailgun.org")
      post :create, representation_from_mailgun
      Email.where(:subject => "test cc").last.copy_to.should == "Jim Knight <jim.knight@lavatech.com>"
    end
  end
end

private
  def representation_from_mailgun
    {"recipient"=>"lavatech@agilechamp.mailgun.org", "sender"=>"jimknight@lavatech.com", "subject"=>"test cc", "from"=>"Jim Knight <jimknight@lavatech.com>", "Received"=>"from [10.0.0.16] (pool-173-71-215-119.clppva.fios.verizon.net. [173.71.215.119]) by mx.google.com with ESMTPS id v3sm2845074qaz.5.2012.07.27.16.55.59 (version=TLSv1/SSLv3 cipher=OTHER); Fri, 27 Jul 2012 16:56:00 -0700 (PDT)", "X-Envelope-From"=>"<jimknight@lavatech.com>", "X-Google-Dkim-Signature"=>"v=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=20120113; h=from:content-type:subject:date:message-id:cc:to:mime-version :x-mailer:x-gm-message-state; bh=JnI8+G1W6jliEgzQ6pMbXleELCldHZGdLQQq5UwSPdY=; b=YJCjwrwckl8FWg15w/ZkRHoCzkVOXVqm6dHn6ZABvE/UXqaPEbYJXWxAwMY01Rz9wI WkqT6nF0UhBWfZ3tuANCLKIqEpgdHMzYtlx1VavS68cjs+Z9l8P0AZ7WIb1g86PwAMqF 2OBRv1gVhK8w5Q2F08yZ+y5FQw3GPftONOjOaSjIzr3Gk8xk8gW+7jEHfPJwUJklKrFK XzJ221oz+uu1mjhkoBhf6ALUjg0DlHtYNc1pwcyCZXHOt9zxkWOUtbv7ZaY55czbeZQ1 DT+y7qYOIJNyq61LlT165UjmxyiXa4unMoD3Vgt0pITqj21gt3Gd7TWkLIDSyFPOzcpL 1Tmw==", "Return-Path"=>"<jimknight@lavatech.com>", "From"=>"Jim Knight <jimknight@lavatech.com>", "Content-Type"=>"multipart/alternative; boundary=\"Apple-Mail=_5B5690BE-2309-449D-BF44-611A343B7122\"", "Subject"=>"test cc", "Date"=>"Fri, 27 Jul 2012 19:55:59 -0400", "Message-Id"=>"<17A57926-20BF-467A-83F4-1710640105C0@lavatech.com>", "Cc"=>"Jim Knight <jim.knight@lavatech.com>", "To"=>"lavatech@agilechamp.mailgun.org", "Mime-Version"=>"1.0 (Apple Message framework v1278)", "X-Mailer"=>"Apple Mail (2.1278)", "X-Gm-Message-State"=>"ALoCoQk5JJZYnMbGMDB5Ossb2u1BRGRlBF/qOJilWEXGLEXkYumQpXZuJ8sSB9uqGXk/rMKTGHJF", "message-headers"=>"[[\"Received\", \"by luna.mailgun.net with SMTP mgrt 6173181; Fri, 27 Jul 2012 23:56:01 +0000\"], [\"X-Envelope-From\", \"<jimknight@lavatech.com>\"], [\"Received\", \"from mail-qc0-f171.google.com (mail-qc0-f171.google.com [209.85.216.171]) by mxa.mailgun.org with ESMTP id 50132a91.46e6db0-luna2; Fri, 27 Jul 2012 23:56:01 -0000 (UTC)\"], [\"Received\", \"by qcad1 with SMTP id d1so1566518qca.30 for <lavatech@agilechamp.mailgun.org>; Fri, 27 Jul 2012 16:56:00 -0700 (PDT)\"], [\"X-Google-Dkim-Signature\", \"v=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=20120113; h=from:content-type:subject:date:message-id:cc:to:mime-version :x-mailer:x-gm-message-state; bh=JnI8+G1W6jliEgzQ6pMbXleELCldHZGdLQQq5UwSPdY=; b=YJCjwrwckl8FWg15w/ZkRHoCzkVOXVqm6dHn6ZABvE/UXqaPEbYJXWxAwMY01Rz9wI WkqT6nF0UhBWfZ3tuANCLKIqEpgdHMzYtlx1VavS68cjs+Z9l8P0AZ7WIb1g86PwAMqF 2OBRv1gVhK8w5Q2F08yZ+y5FQw3GPftONOjOaSjIzr3Gk8xk8gW+7jEHfPJwUJklKrFK XzJ221oz+uu1mjhkoBhf6ALUjg0DlHtYNc1pwcyCZXHOt9zxkWOUtbv7ZaY55czbeZQ1 DT+y7qYOIJNyq61LlT165UjmxyiXa4unMoD3Vgt0pITqj21gt3Gd7TWkLIDSyFPOzcpL 1Tmw==\"], [\"Received\", \"by 10.224.42.76 with SMTP id r12mr378411qae.96.1343433360714; Fri, 27 Jul 2012 16:56:00 -0700 (PDT)\"], [\"Return-Path\", \"<jimknight@lavatech.com>\"], [\"Received\", \"from [10.0.0.16] (pool-173-71-215-119.clppva.fios.verizon.net. [173.71.215.119]) by mx.google.com with ESMTPS id v3sm2845074qaz.5.2012.07.27.16.55.59 (version=TLSv1/SSLv3 cipher=OTHER); Fri, 27 Jul 2012 16:56:00 -0700 (PDT)\"], [\"From\", \"Jim Knight <jimknight@lavatech.com>\"], [\"Content-Type\", \"multipart/alternative; boundary=\\\"Apple-Mail=_5B5690BE-2309-449D-BF44-611A343B7122\\\"\"], [\"Subject\", \"test cc\"], [\"Date\", \"Fri, 27 Jul 2012 19:55:59 -0400\"], [\"Message-Id\", \"<17A57926-20BF-467A-83F4-1710640105C0@lavatech.com>\"], [\"Cc\", \"Jim Knight <jim.knight@lavatech.com>\"], [\"To\", \"lavatech@agilechamp.mailgun.org\"], [\"Mime-Version\", \"1.0 (Apple Message framework v1278)\"], [\"X-Mailer\", \"Apple Mail (2.1278)\"], [\"X-Gm-Message-State\", \"ALoCoQk5JJZYnMbGMDB5Ossb2u1BRGRlBF/qOJilWEXGLEXkYumQpXZuJ8sSB9uqGXk/rMKTGHJF\"]]", "timestamp"=>"1343433363", "token"=>"8oddkjgj2xc1pr9b7w3m7kxvkopih35srbva4u9nxaxu-l6ql4", "signature"=>"137eaee72abe61664ad613fc9454965cec7da4bc1db7e5a993dc1910de7eb934", "body-plain"=>"\r\n\r\nJim Knight @jimknight\r\nDirector LavaTech, Inc.\r\nLinkedin profile\r\n703.665.0176\r\n\r\n\r\n\r\n", "body-html"=>"<html><head></head><body style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; \"><br><div>\r\n<span class=\"Apple-style-span\" style=\"border-collapse: separate; color: rgb(0, 0, 0); font-family: Helvetica; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium; \"><span class=\"Apple-style-span\" style=\"border-collapse: separate; color: rgb(0, 0, 0); font-family: Helvetica; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium; \"><div style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; \"><span class=\"Apple-style-span\" style=\"border-collapse: separate; color: rgb(0, 0, 0); font-family: Helvetica; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium; \"><br class=\"Apple-interchange-newline\">Jim Knight&nbsp;<a href=\"http://twitter.com/jimknight\">@jimknight</a><br>Director&nbsp;<a href=\"http://lavatech.com\">LavaTech, Inc.</a></span></div><div style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; \"><span class=\"Apple-style-span\" style=\"border-collapse: separate; color: rgb(0, 0, 0); font-family: Helvetica; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium; \"><font class=\"Apple-style-span\" color=\"#000000\"><a href=\"http://twitter.com/jimknight\"></a><a href=\"http://www.linkedin.com/in/lavatech\">Linkedin profile</a><br></font>703.665.0176<br><br><br></span></div></span></span>\r\n</div>\r\n<br></body></html>", "stripped-html"=>"<html><head></head><body style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; \"><br><div>\r\n<span class=\"Apple-style-span\" style=\"border-collapse: separate; color: rgb(0, 0, 0); font-family: Helvetica; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium; \"><span class=\"Apple-style-span\" style=\"border-collapse: separate; color: rgb(0, 0, 0); font-family: Helvetica; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium; \"><div style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; \"><span class=\"Apple-style-span\" style=\"border-collapse: separate; color: rgb(0, 0, 0); font-family: Helvetica; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium; \"><br class=\"Apple-interchange-newline\">Jim Knight&nbsp;<a href=\"http://twitter.com/jimknight\">@jimknight</a><br>Director&nbsp;<a href=\"http://lavatech.com\">LavaTech, Inc.</a></span></div><div style=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; \"><span class=\"Apple-style-span\" style=\"border-collapse: separate; color: rgb(0, 0, 0); font-family: Helvetica; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium; \"><font class=\"Apple-style-span\" color=\"#000000\"><a href=\"http://twitter.com/jimknight\"></a><a href=\"http://www.linkedin.com/in/lavatech\">Linkedin profile</a><br></font>703.665.0176<br><br><br></span></div></span></span>\r\n</div>\r\n<br></body></html>", "stripped-text"=>"Jim Knight @jimknight\r\nDirector LavaTech, Inc.\r\nLinkedin profile\r\n703.665.0176", "stripped-signature"=>""}
  end